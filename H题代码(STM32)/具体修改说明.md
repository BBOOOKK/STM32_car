# 具体修改说明

## 修改的文件：H题代码(STM32)/User/main.c

### 1. 添加了必要的头文件包含
```c
#include "Track.h"                     // 循迹传感器模块头文件
#include "Key.h"                       // 按键模块头文件（用于调试模式切换）
```

### 2. 定义了方向状态枚举和速度参数
```c
// 定义方向状态的编码，便于电机控制
typedef enum {
    DIR_STOP = 0,      // 停止或未检测到线
    DIR_HARD_LEFT,     // 极左转弯
    DIR_LEFT,          // 左转
    DIR_STRAIGHT,      // 直行
    DIR_RIGHT,         // 右转
    DIR_HARD_RIGHT     // 极右转弯
} DirectionStatus;

// 电机速度配置参数（可根据实际硬件调整）
#define SPEED_STOP          0      // 停止速度
#define SPEED_STRAIGHT      1000   // 直行速度
#define SPEED_TURN          800    // 普通转弯速度
#define SPEED_HARD_TURN     600    // 急转弯速度
#define SPEED_MIN           400    // 最小速度（用于微调）
#define SPEED_MAX           1200   // 最大速度（注意不要超过PWM最大值）
```

### 3. 添加了全局变量
```c
// 调试模式标志
static uint8_t debug_mode = 0;     // 0=正常模式，1=调试模式

// 全局变量：当前方向状态和各红外传感器感应状态（1表示检测到白线，0表示检测到蓝色地面）
static DirectionStatus dir_status = DIR_STOP;
static uint8_t sw1_line = 0;
static uint8_t sw2_line = 0;
static uint8_t sw3_line = 0;
static uint8_t sw4_line = 0;
```

### 4. 重写了Get_dir()函数 - 这是核心修改

**原始逻辑（可能存在的问题）**：
- 传感器映射错误
- 巡线逻辑不完整
- 没有正确处理白线检测

**新实现的Get_dir()函数**：
```c
void Get_dir(void) {
    // 使用Track模块的函数读取传感器状态
    Track_Read_All(&sw1_line, &sw2_line, &sw3_line, &sw4_line);
    
    // 使用巡线模块的算法逻辑（直接使用swX_line，因为白线检测逻辑与黑线检测相反）
    // 左大弯：(L1或L2检测到白线)且R2检测到白线 → 左旋转
    if ((sw1_line || sw2_line) && sw4_line) {
        dir_status = DIR_HARD_LEFT;
    }
    // 右大弯：L1检测到白线且(R1或R2检测到白线) → 右旋转
    else if (sw1_line && (sw3_line || sw4_line)) {
        dir_status = DIR_HARD_RIGHT;
    }
    // 左最外侧检测：L1检测到白线 → 左旋转
    else if (sw1_line) {
        dir_status = DIR_LEFT;
    }
    // 右最外侧检测：R2检测到白线 → 右旋转
    else if (sw4_line) {
        dir_status = DIR_RIGHT;
    }
    // 中间微调左转：L2检测到白线且R1未检测到白线 → 左转
    else if (sw2_line && !sw3_line) {
        dir_status = DIR_LEFT;
    }
    // 中间微调右转：L2未检测到白线且R1检测到白线 → 右转
    else if (!sw2_line && sw3_line) {
        dir_status = DIR_RIGHT;
    }
    // 中间都在白线上：L2检测到白线且R1检测到白线 → 加速前进
    else if (sw2_line && sw3_line) {
        dir_status = DIR_STRAIGHT;
    }
    // 其他情况：停止（未检测到白线或检测到部分白线但不符合上述条件）
    else {
        dir_status = DIR_STOP;
    }
}
```

### 5. 修改了main()函数中的初始化部分
```c
// 初始化相关模块（OLED显示、舵机、电机、循迹传感器等）
Delay_Init();               // 初始化延时功能（确保 OLED_Init 中延时可用）
OLED_Init();                // 初始化 OLED 显示屏
// Servo_Init();            // 初始化舵机控制（未使用舵机时可不调用）
Motor_Init();               // 初始化电机控制（PWM输出等）
Track_Init();               // 初始化循迹传感器模块
Key_Init();                 // 初始化按键（用于调试模式切换）
```

### 6. 添加了调试模式切换功能
```c
// 检查按键，切换调试模式
uint8_t key = Key_GetNum();
if (key == 1) {  // 假设按键1用于切换调试模式
    debug_mode = !debug_mode;
    OLED_Clear();
    if (debug_mode) {
        OLED_ShowString(1, 1, "Debug Mode ON");
    } else {
        OLED_ShowString(1, 1, "Normal Mode ON");
    }
    Delay_ms(500);
}
```

### 7. 添加了根据方向状态控制电机的逻辑
```c
// 根据方向状态控制左右电机速度，差速转向
switch (dir_status) {
    case DIR_HARD_LEFT:
        // 极左转：左轮减速，右轮正常速度
        Move_control(SPEED_HARD_TURN, SPEED_STRAIGHT);
        break;
    case DIR_LEFT:
        // 左转：左轮偏慢，右轮正常速度
        Move_control(SPEED_TURN, SPEED_STRAIGHT);
        break;
    case DIR_STRAIGHT:
        // 直行：两轮速度相同
        Move_control(SPEED_STRAIGHT, SPEED_STRAIGHT);
        break;
    case DIR_RIGHT:
        // 右转：右轮偏慢，左轮正常速度
        Move_control(SPEED_STRAIGHT, SPEED_TURN);
        break;
    case DIR_HARD_RIGHT:
        // 极右转：右轮减速，左轮正常速度
        Move_control(SPEED_STRAIGHT, SPEED_HARD_TURN);
        break;
    case DIR_STOP:
    default:
        // 停止状态：停车
        Move_control(SPEED_STOP, SPEED_STOP);
        break;
}
```

### 8. 添加了详细的OLED显示功能
- **调试模式**：显示详细的传感器数值和方向状态
- **正常模式**：显示简洁的传感器状态、方向指示和速度信息

## 关键修改点总结

1. **传感器映射修正**：
   - 原始代码可能使用了错误的传感器映射
   - 新代码使用正确的映射：SW1(PA1)=L1, SW2(PA0)=L2, SW3(PA2)=R1, SW4(PA3)=R2

2. **巡线算法集成**：
   - 从巡线模块中提取了完整的巡线算法
   - 实现了8种巡线状态判断
   - 针对白线检测优化了逻辑

3. **白线检测逻辑**：
   - Track_Read_All()函数返回1表示检测到白线，0表示检测到蓝色地面
   - 正确处理了白线检测与黑线检测的逻辑差异

4. **差速转向控制**：
   - 通过调整左右电机速度实现精确转向
   - 配置了可调的速度参数

5. **调试功能**：
   - 添加了调试模式切换
   - 增强了OLED显示功能

## 修改来源

巡线算法来源于：`STM32F103C8T6驱动/4WD智能车/code (2)/code/STM32四驱车运动库函数版本/Source/APP/app_linewalking.c`

## 验证结果

- 代码编译成功：0错误
- 生成的可执行文件：Project.axf, Project.hex
- 代码大小：5056字节，适合STM32F103C8T6的64KB Flash

## 硬件连接确认

传感器连接（从车身后面往前看）：
```
左侧到右边巡线传感器顺序：L1 L2 |白线| R1 R2
对应GPIO引脚：
- L1 (最左) → PA1 (SW1)
- L2 (左中) → PA0 (SW2)  
- R1 (右中) → PA2 (SW3)
- R2 (最右) → PA3 (SW4)
```

这些修改使小车能够在蓝色地面上成功巡白线。
