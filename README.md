# STM32 8路巡线智能小车

基于STM32F103C8T6微控制器的8路巡线智能小车系统，使用8路灰度传感器阵列实现高精度黑线跟踪。

## 主要特性

- **8路高精度传感器**：红外灰度传感器阵列，提供精确线路检测
- **加权平均算法**：对称权重计算位置偏差，提高控制精度
- **15状态状态机**：精细控制逻辑（L7-L1, M, R1-R7）
- **双控制模式**：支持舵机四轮控制和差速控制
- **实时状态显示**：OLED显示屏显示传感器状态和系统信息
- **模块化设计**：硬件驱动与应用程序分离，便于维护

## 项目结构

```
STM32_car/
├── README.md                          # 项目说明
├── 巡线传感器/                         # 巡线传感器资源
│   ├── 原理图/                        # 电路原理图
│   ├── 引脚示意图/                     # 引脚连接图
│   └── 多平台驱动/                     # Arduino、树莓派、STM32等驱动
├── STM32_8路巡线/                      # 8路巡线主项目
│   └── STM32/
│       ├── Hardware/                  # 硬件驱动层
│       ├── User/                      # 用户应用层
│       ├── Library/                   # STM32标准库
│       └── Project.uvprojx            # Keil工程文件
└── STM32F103C8T6驱动/                  # 驱动示例
```

## 硬件配置

- **主控芯片**：STM32F103C8T6 (Cortex-M3, 72MHz)
- **传感器**：8路红外灰度传感器 (GPIOA0-7)
- **执行机构**：PWM控制直流电机，舵机转向
- **显示**：I2C接口0.96寸OLED
- **交互**：蜂鸣器、按键

## 核心算法

### 传感器数据处理
```c
// 8路传感器权重数组（左负右正）
static const int8_t w[8] = { -7, -5, -3, -1, 1, 3, 5, 7 };

// 偏差计算：Err = Σ(w[i] * sensor_state[i]) / Σ(sensor_state[i])
float Track_Err(uint16_t car_state);
```

### 状态机控制
15状态枚举状态机，映射到方向控制值：
```c
static const int16_t dir_map[15] = {
    -200, -180, -160, -130, -110, -80, -50, 0,
     50,   80,  110,  130,  160,  180, 200
};
```

## 快速开始

### 开发环境
- **IDE**：Keil MDK-ARM uVision5
- **编译器**：ARMCC V5
- **调试器**：ST-Link V2

### 编译烧录
1. 打开 `STM32_8路巡线/STM32/Project.uvprojx`
2. 确认设备型号为 STM32F103C8T6
3. 编译工程生成 `Project.axf`
4. 通过ST-Link烧录到目标板

### 硬件连接
1. **电源**：5V电源连接到小车电源接口
2. **调试接口**：ST-Link SWD连接
3. **传感器**：8路传感器连接到GPIOA0-7
4. **电机**：电机驱动板连接到PWM输出引脚
5. **OLED**：I2C接口连接到对应引脚

## 使用说明

### 启动流程
1. 上电初始化所有外设
2. 蜂鸣器发出启动提示音
3. OLED显示欢迎信息
4. 自动开始巡线控制

### OLED显示内容
```
S0 S1 S2 S3 S4 S5 S6 S7  (8路传感器状态)
方向值: xxx              (当前方向控制值)
上状态 趋势 当前状态     (状态机信息)
```

## 参数调整

### 关键配置参数
```c
// 传感器极性（1:在线输出低电平，0:在线输出高电平）
#define TRACK_ACTIVE_LOW 1

// 方向控制映射表（根据实际赛道调整）
static const int16_t dir_map[15] = { ... };

// 电机控制参数
Move_control(1100+0.7*dir, 1125-0.2*dir);  // 右转
Move_control(1100+0.2*dir, 1125-0.7*dir);  // 左转
```

## 扩展功能

### 已实现
- [x] 8路传感器驱动与加权平均算法
- [x] 15状态状态机控制
- [x] 实时OLED状态显示
- [x] 丢线检测与恢复
- [x] 双控制模式（舵机/差速）

### 计划中
- [ ] PID速度闭环控制
- [ ] 编码器测速
- [ ] 蓝牙远程监控
- [ ] 摄像头视觉辅助

## 故障排除

### 常见问题
1. **小车不移动**：检查电源、PWM输出、电机连接
2. **传感器无响应**：检查供电、GPIO连接、安装高度
3. **巡线不稳定**：调整参数、校准传感器、检查机械结构
4. **OLED不显示**：检查I2C连接、电源、地址设置

## 许可证

MIT许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 贡献

欢迎通过GitHub Issues报告问题或提交Pull Request改进项目。

## 项目链接

- **GitHub仓库**：https://github.com/BBOOOKK/STM32_car
- **维护者**：BBOOOKK
- **最后更新**：2025年12月25日

---

*让智能小车在赛道上自由驰骋，探索嵌入式控制的无限可能！*
