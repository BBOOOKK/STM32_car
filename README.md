# STM32 8路巡线智能小车项目

## 项目概述

本项目是一个基于STM32F103C8T6微控制器的8路巡线智能小车系统，使用8路灰度传感器阵列实现高精度黑线跟踪功能。小车通过8个红外灰度传感器检测地面黑线，采用加权平均算法计算位置偏差，通过舵机和差速控制实现精确的路径跟踪。

## 项目特点

- **8路高精度传感器**: 使用8个红外灰度传感器，提供更精确的线路检测
- **加权平均算法**: 采用对称权重计算位置偏差，提高控制精度
- **状态机控制**: 15状态枚举状态机（L7-L1, M, R1-R7）实现精细控制
- **多种控制模式**: 支持舵机四轮控制和差速控制
- **实时状态显示**: OLED显示屏实时显示8路传感器状态和系统信息
- **模块化设计**: 硬件驱动与应用程序分离，便于维护和扩展

## 项目结构

```
STM32_car/
├── README.md                          # 项目说明文档
├── 巡线传感器/                         # 巡线传感器相关资源
│   ├── 1、巡线模块的测试与调试（必看）/   # 测试与调试资料
│   ├── 2、Arduino驱动程序/             # Arduino平台驱动
│   ├── 3、树莓派驱动程序/              # 树莓派平台驱动
│   ├── 4、51驱动程序/                  # 51单片机驱动
│   ├── 5、STM32驱动程序/               # STM32平台驱动
│   │   ├── GD32F103C8T6驱动/          # GD32芯片驱动
│   │   ├── STM32F103C8T6驱动/         # STM32F103C8T6驱动
│   │   └── STM32F103RCT6&APM32f103RET6驱动/
│   ├── 6、microbit驱动程序/           # microbit平台驱动
│   ├── 7、MSPM0驱动程序/              # MSPM0平台驱动
│   ├── 引脚示意图/                     # 传感器引脚连接图
│   └── 原理图/                        # 电路原理图
├── STM32_8路巡线/                      # 8路巡线主项目代码
│   └── STM32/
│       ├── Hardware/                  # 硬件驱动层
│       │   ├── Track.c/h              # 8路巡线传感器驱动
│       │   ├── Motor.c/h              # 电机驱动
│       │   ├── PID.c/h                # PID控制算法
│       │   ├── Encoder.c/h            # 编码器测速
│       │   ├── Servor.c/h             # 舵机控制
│       │   ├── OLED.c/h               # OLED显示
│       │   ├── Buzzer.c/h             # 蜂鸣器控制
│       │   ├── Key.c/h                # 按键处理
│       │   └── ...                    # 其他硬件驱动
│       ├── User/                      # 用户应用层
│       │   ├── main.c                 # 主程序（8路巡线控制逻辑）
│       │   └── main.h                 # 主程序头文件
│       ├── Library/                   # STM32标准库
│       └── Project.uvprojx            # Keil MDK工程文件
├── STM32/                             # 5路巡线项目（旧版本）
└── STM32F103C8T6驱动/                  # 驱动示例和实验
    └── 4WD智能车/                      # 四轮驱动智能车示例
```

## 硬件配置

### 核心控制器
- **主控芯片**: STM32F103C8T6 (ARM Cortex-M3内核)
- **工作频率**: 72MHz
- **Flash**: 64KB, RAM: 20KB
- **开发板**: 最小系统板或自定义PCB

### 8路巡线传感器模块
- **传感器数量**: 8路红外灰度传感器阵列
- **连接端口**: GPIOA
- **引脚分配**:
  - Track_S0 (GPIO_Pin_0) - 最左侧传感器
  - Track_S1 (GPIO_Pin_1)
  - Track_S2 (GPIO_Pin_2)
  - Track_S3 (GPIO_Pin_3)
  - Track_S4 (GPIO_Pin_4)
  - Track_S5 (GPIO_Pin_5)
  - Track_S6 (GPIO_Pin_6)
  - Track_S7 (GPIO_Pin_7) - 最右侧传感器
- **传感器极性**: 可配置（TRACK_ACTIVE_LOW宏定义）
  - 1: 传感器在线时输出低电平（默认）
  - 0: 传感器在线时输出高电平

### 执行机构
- **电机驱动**: PWM控制直流电机，支持差速转向
- **舵机控制**: 用于前轮转向控制
- **编码器**: 用于速度测量和闭环控制（可选）

### 人机交互
- **OLED显示屏**: I2C接口0.96寸OLED，实时显示传感器状态
- **蜂鸣器**: 系统状态提示音
- **按键**: 用户输入和控制模式切换

## 软件架构

### 核心算法

#### 1. 8路巡线传感器驱动 (`Track.c/h`)
```c
// 传感器初始化
void Track_Init(void);

// 读取8路传感器数据（8位掩码，Bit7..Bit0 = S0..S7）
void Read_Track_DATA(uint8_t* arr);

// 计算位置偏差（加权平均算法）
float Track_Err(uint16_t car_state);
```

**加权平均算法**:
```c
/* 对称权重数组：左负右正 */
static const int8_t w[8] = { -7, -5, -3, -1, 1, 3, 5, 7 };

/* 偏差计算公式：Err = Σ(w[i] * sensor_state[i]) / Σ(sensor_state[i]) */
```

#### 2. 15状态状态机 (`main.c`)
系统使用15状态枚举状态机实现精细控制：
```c
enum status {
    L7, L6, L5, L4, L3, L2, L1,  // 左侧7个偏移状态
    M,                           // 居中状态
    R1, R2, R3, R4, R5, R6, R7   // 右侧7个偏移状态
} dir_status, last_dir_status;
```

#### 3. 控制映射表
```c
/* 状态到方向控制值的映射 */
static const int16_t dir_map[15] = {
    -200, -180, -160, -130, -110, -80, -50, 0,
     50,   80,  110,  130,  160,  180, 200
};
```

### 主要功能模块

1. **传感器数据采集**: 实时读取8路灰度传感器状态
2. **位置偏差计算**: 加权平均算法计算当前位置偏差
3. **状态判断**: 根据偏差值映射到15个状态之一
4. **方向控制**: 通过状态映射表获取控制值
5. **电机控制**: PWM调节电机速度，支持差速转向
6. **舵机控制**: 前轮转向控制（可选）
7. **状态显示**: OLED实时显示8路传感器状态和系统信息
8. **异常处理**: 丢线检测和恢复策略

## 工作原理

### 巡线原理
1. **红外检测**: 每个传感器发射红外光并接收反射光
2. **黑白区分**: 
   - 黑色表面吸收红外光 → 反射弱 → 传感器输出低电平（在线）
   - 白色表面反射红外光 → 反射强 → 传感器输出高电平（离线）
3. **位置计算**: 通过8个传感器的组合状态，使用加权平均算法计算精确位置

### 控制流程
```
8路传感器数据采集 → 加权平均计算偏差 → 状态映射 → 控制输出 → 电机/舵机执行
      ↑                                                              ↓
      └─────────────── 状态反馈与调整 ─────────────────┘
```

### 状态转换逻辑
- **居中状态(M)**: 偏差接近0，小车在线路中央
- **轻微偏移(L1/R1)**: 偏差±1，轻微调整
- **中等偏移(L2-L3/R2-R3)**: 偏差±2-±3，中等幅度调整
- **明显偏移(L4-L5/R4-R5)**: 偏差±4-±5，明显调整
- **严重偏移(L6-L7/R6-R7)**: 偏差±6-±7，大幅度调整

### 丢线处理策略
1. **趋势保持**: 根据最后已知的转向趋势继续转向
2. **边界限制**: 状态保持在L7或R7边界
3. **恢复检测**: 持续检测传感器状态，一旦检测到线路立即恢复

## 编译与烧录

### 开发环境
- **IDE**: Keil MDK-ARM uVision5
- **编译器**: ARMCC V5
- **调试器**: J-Link或ST-Link V2
- **设备包**: STM32F1系列设备支持包

### 编译步骤
1. 打开 `STM32_8路巡线/STM32/Project.uvprojx` 工程文件
2. 确认设备型号为 STM32F103C8T6
3. 设置晶振频率为 8MHz（HSE）
4. 配置正确的头文件路径和库文件
5. 编译工程生成 `Project.axf` 文件
6. 通过ST-Link烧录到目标板

### 硬件连接
1. **电源连接**: 5V电源连接到小车电源接口
2. **调试接口**: ST-Link的SWD接口连接（SWDIO, SWCLK, GND, 3.3V）
3. **传感器连接**: 8路传感器连接到GPIOA的0-7引脚
4. **电机连接**: 电机驱动板连接到对应的PWM输出引脚
5. **OLED连接**: I2C接口（SCL, SDA）连接到对应引脚

## 使用说明

### 启动流程
1. **上电初始化**: 系统初始化所有外设
2. **自检提示**: 蜂鸣器发出启动提示音，OLED显示欢迎信息
3. **传感器校准**: 自动检测传感器状态（可选）
4. **进入主循环**: 开始巡线控制

### 操作模式
- **自动巡线模式**: 上电后自动开始巡线
- **调试模式**: 通过按键切换，显示详细传感器数据
- **手动控制模式**: 通过按键手动控制小车（如实现）

### OLED显示内容
```
第1行: S0 S1 S2 S3 S4 S5 S6 S7  (8路传感器状态，十六进制显示)
第2行: 方向值: xxx              (当前方向控制值，-200~+200)
第3行: 上状态 趋势 当前状态     (状态机信息)
示例: L2  ->  R1
```

## 参数调整与优化

### 关键参数配置

#### 1. 传感器参数 (`Track.h`)
```c
/* 传感器极性配置 */
#define TRACK_ACTIVE_LOW 1  // 1:在线输出低电平，0:在线输出高电平

/* 传感器权重数组 (Track.c) */
static const int8_t w[8] = { -7, -5, -3, -1, 1, 3, 5, 7 };
```

#### 2. 控制参数 (`main.c`)
```c
/* 状态到方向值的映射表 */
static const int16_t dir_map[15] = {
    -200, -180, -160, -130, -110, -80, -50, 0,
     50,   80,  110,  130,  160,  180, 200
};

/* 电机控制参数 */
Move_control(1100+0.7*dir, 1125-0.2*dir);  // 右转时
Move_control(1100+0.2*dir, 1125-0.7*dir);  // 左转时
```

#### 3. 偏差计算参数
- **权重值**: 调整w[]数组改变各传感器的贡献度
- **灵敏度**: 调整dir_map数组改变转向响应
- **死区设置**: 在Track_Err()函数中调整零偏处理

### 调试技巧
1. **实时监控**: 使用OLED观察8路传感器实时状态
2. **参数微调**: 根据实际赛道调整dir_map值
3. **响应测试**: 测试不同弯道的转向响应，优化参数
4. **丢线测试**: 测试丢线恢复性能，调整趋势保持策略
5. **速度平衡**: 调整电机PWM参数，平衡速度与稳定性

## 扩展功能

### 已实现功能
- [x] 8路高精度巡线传感器驱动
- [x] 加权平均位置偏差算法
- [x] 15状态状态机控制
- [x] 实时OLED状态显示
- [x] 蜂鸣器提示音
- [x] 丢线检测与恢复
- [x] 舵机/差速双控制模式
- [x] 按键输入控制

### 可扩展功能
- [ ] PID速度闭环控制
- [ ] 编码器测速与里程计算
- [ ] MPU6050姿态传感器融合
- [ ] 蓝牙/WiFi远程监控与控制
- [ ] 摄像头视觉辅助巡线
- [ ] 多赛道模式记忆
- [ ] 自动速度调节（直道加速，弯道减速）
- [ ] 赛道元素识别（十字路口、坡道等）

## 故障排除

### 常见问题及解决方法

#### 1. 小车不移动或移动异常
- **检查电源**: 确保电机驱动板和主控板供电正常
- **验证PWM输出**: 使用示波器或逻辑分析仪检查PWM信号
- **检查电机连接**: 确认电机线连接正确，无松动
- **测试电机单独**: 直接给电机供电测试是否正常

#### 2. 传感器无响应或误检测
- **检查传感器供电**: 确保5V电源正常
- **验证GPIO连接**: 检查GPIOA0-7连接是否正确
- **测试传感器**: 单独测试每个传感器的工作状态
- **调整安装高度**: 优化传感器与地面的距离（通常2-3cm）
- **环境光干扰**: 避免强光直射，考虑增加遮光罩

#### 3. 巡线不稳定或抖动
- **参数优化**: 调整dir_map和权重参数
- **传感器校准**: 重新校准传感器阈值
- **机械调整**: 检查小车机械结构，确保平稳
- **速度调整**: 降低速度提高稳定性
- **滤波算法**: 添加软件滤波减少噪声

#### 4. 编译或烧录问题
- **设备包安装**: 确认已安装STM32F1系列设备支持包
- **工程配置**: 检查Device选项是否为STM32F103C8T6
- **头文件路径**: 确认所有头文件路径正确
- **库文件**: 确保STM32标准库文件完整
- **调试器连接**: 检查ST-Link连接和驱动

#### 5. OLED不显示或显示异常
- **I2C连接**: 检查SCL和SDA线连接
- **电源检查**: 确认OLED模块供电正常
- **地址设置**: 确认OLED的I2C地址（通常0x78或0x7A）
- **初始化代码**: 检查OLED_Init()函数是否正确

### 调试工具推荐
1. **Keil Debugger**: 单步调试，查看变量值
2. **逻辑分析仪**: 分析PWM信号时序和传感器信号
3. **串口调试**: 添加printf输出调试信息
4. **万用表**: 检查电源电压和信号电平
5. **示波器**: 分析信号质量和时序

## 性能优化建议

### 算法优化
1. **自适应权重**: 根据赛道特性动态调整权重
2. **预测控制**: 加入预测算法提前调整转向
3. **模糊控制**: 使用模糊逻辑替代固定映射表
4. **机器学习**: 收集数据训练控制模型

### 硬件优化
1. **传感器升级**: 使用更高精度或更多路传感器
2. **电机升级**: 使用编码电机实现精确速度控制
3. **主控升级**: 升级到更高性能的STM32系列
4. **电源优化**: 使用锂电池和高效稳压电路

### 软件优化
1. **RTOS集成**: 使用FreeRTOS实现多任务管理
2. **通信协议**: 添加CAN或以太网通信
3. **数据记录**: 实现SD卡数据记录功能
4. **远程升级**: 支持OTA固件升级

## 资源文件

### 文档资料
- `巡线传感器/原理图/`: 电路原理图（PDF和图片）
- `巡线传感器/引脚示意图/`: 详细引脚连接图
- `巡线传感器/1、巡线模块的测试与调试（必看）/`: 传感器测试指南

### 视频教程
- `巡线传感器/2、Arduino驱动程序/寻线视频教程.avi`: 基础巡线教程
- `STM32F103C8T6驱动/4WD智能车/6.小车巡线实验.avi`: 小车巡线演示

### 多平台驱动示例
- **Arduino**: 快速原型开发示例
- **树莓派**: Python/C++驱动示例
- **51单片机**: 传统单片机实现
- **microbit**: 图形化编程示例
- **MSPM0**: TI MSPM0系列驱动

## 开发指南

### 代码规范
1. **命名规范**: 使用有意义的变量和函数名
   - 全局变量: `g_` 前缀，如 `g_system_state`
   - 局部变量: 小写字母和下划线，如 `sensor_value`
   - 函数名: 动词+名词，如 `Track_Init()`, `Motor_SetSpeed()`
   - 宏定义: 全大写，如 `TRACK_ACTIVE_LOW`
   - 枚举类型: 首字母大写，如 `enum Status`

2. **文件组织**: 模块化设计，每个功能模块独立文件
   - 硬件驱动: `Hardware/` 目录下，如 `Track.c/h`, `Motor.c/h`
   - 应用程序: `User/` 目录下，如 `main.c/h`
   - 库文件: `Library/` 目录下，STM32标准库

3. **注释规范**: 清晰的注释说明
   - 文件头注释: 文件功能、作者、日期、版本
   - 函数注释: 功能、参数、返回值、注意事项
   - 关键代码注释: 算法原理、特殊处理说明
   - Doxygen风格: 支持文档自动生成

4. **代码风格**: 统一的代码格式
   - 缩进: 4个空格（不使用Tab）
   - 大括号: K&R风格（左括号同行，右括号单独一行）
   - 行长度: 不超过80个字符
   - 空格使用: 运算符两侧、逗号后加空格

### 版本控制
1. **Git工作流**: 使用Git进行版本控制
   - 主分支: `main` - 稳定版本
   - 开发分支: `develop` - 开发版本
   - 功能分支: `feature/*` - 新功能开发
   - 修复分支: `fix/*` - Bug修复

2. **提交规范**: 有意义的提交信息
   - 格式: `<类型>: <描述>`
   - 类型: feat(新功能), fix(Bug修复), docs(文档), style(格式), refactor(重构), test(测试), chore(维护)
   - 示例: `feat: 添加8路传感器加权平均算法`

3. **版本标签**: 重要版本打标签
   - 格式: `v1.0.0` (主版本.次版本.修订版本)
   - 说明: 每个发布版本创建标签和发布说明

### 测试流程
1. **单元测试**: 模块级功能测试
   - 传感器驱动测试: 验证8路传感器数据读取
   - 算法测试: 加权平均算法正确性验证
   - 控制逻辑测试: 状态机转换测试

2. **集成测试**: 系统级功能测试
   - 硬件集成测试: 所有外设协同工作
   - 巡线功能测试: 实际赛道测试
   - 性能测试: 响应时间、稳定性测试

3. **回归测试**: 确保修改不影响现有功能
   - 自动化测试脚本
   - 测试用例库维护
   - 持续集成环境

### 文档维护
1. **代码文档**: 代码即文档
   - 清晰的函数和变量命名
   - 必要的注释说明
   - API文档自动生成

2. **用户文档**: 使用说明
   - 硬件连接指南
   - 软件配置说明
   - 故障排除手册

3. **开发文档**: 技术细节
   - 架构设计文档
   - 算法原理说明
   - 接口定义文档

## 贡献指南

### 如何贡献
1. **报告问题**: 在GitHub Issues中报告Bug或建议
   - 提供详细的问题描述
   - 包含复现步骤
   - 提供相关日志或截图

2. **提交代码**: 通过Pull Request提交改进
   - Fork项目仓库
   - 创建功能分支
   - 编写清晰的提交信息
   - 确保代码通过测试

3. **改进文档**: 完善项目文档
   - 修正错误或过时信息
   - 添加新的使用示例
   - 翻译或本地化文档

### 开发环境设置
1. **软件安装**:
   - Keil MDK-ARM uVision5
   - STM32CubeMX (可选，用于引脚配置)
   - Git版本控制工具
   - 串口调试工具 (如Putty、SecureCRT)

2. **硬件准备**:
   - STM32F103C8T6开发板
   - 8路巡线传感器模块
   - 电机驱动板
   - 直流电机和车轮
   - ST-Link V2调试器
   - 5V电源适配器

3. **环境配置**:
   - 安装STM32F1系列设备支持包
   - 配置Keil工程路径
   - 设置正确的编译器选项
   - 配置调试器连接

### 代码审查流程
1. **Pull Request要求**:
   - 代码符合项目规范
   - 包含必要的测试
   - 更新相关文档
   - 通过所有现有测试

2. **审查重点**:
   - 代码质量和可读性
   - 功能正确性和完整性
   - 性能影响评估
   - 向后兼容性考虑

3. **合并标准**:
   - 至少一名核心开发者批准
   - 通过自动化测试
   - 解决所有审查意见
   - 符合项目路线图

## 许可证

本项目采用 **MIT许可证** - 查看 [LICENSE](LICENSE) 文件了解详情。

### 许可证条款
1. **使用自由**: 允许自由使用、复制、修改、合并、发布、分发、再许可和/或销售本软件
2. **条件**: 在软件和软件的所有副本中包含版权声明和许可声明
3. **免责声明**: 本软件按"原样"提供，不提供任何明示或暗示的担保
4. **责任限制**: 作者或版权持有人不对因软件或使用或其他软件交易引起的任何索赔、损害或其他责任负责

### 第三方库许可证
- **STM32标准外设库**: STMicroelectronics许可证
- **OLED驱动库**: 通常为MIT或BSD许可证
- **其他依赖**: 查看各库的许可证文件

## 致谢

### 项目贡献者
- **项目维护者**: [BBOOOKK](https://github.com/BBOOOKK)
- **代码贡献者**: 查看 [GitHub贡献者页面](https://github.com/BBOOOKK/STM32_car/graphs/contributors)
- **文档贡献者**: 所有提供反馈和改进建议的用户

### 参考资源
1. **STM32官方文档**:
   - STM32F103C8T6参考手册
   - STM32标准外设库用户手册
   - STM32CubeMX配置工具

2. **相关开源项目**:
   - Arduino巡线小车项目
   - ROS智能车项目
   - 其他STM32巡线项目

3. **技术社区**:
   - STM32中文社区
   - 电子工程世界
   - GitHub开源社区

### 特别感谢
- 所有测试用户提供的宝贵反馈
- 开源社区的技术支持和资源共享
- 教育机构的教学应用和推广

## 更新日志

### v1.0.0 (2024-12-24)
- **初始发布**: 基于STM32F103C8T6的8路巡线智能小车系统
- **核心功能**:
  - 8路灰度传感器阵列驱动
  - 加权平均位置偏差算法
  - 15状态状态机控制
  - 实时OLED状态显示
  - 舵机/差速双控制模式
- **文档**: 完整的项目说明文档
- **示例**: 多平台驱动示例代码

### 未来计划
- **v1.1.0**: 添加PID速度闭环控制
- **v1.2.0**: 集成编码器测速功能
- **v1.3.0**: 添加蓝牙远程控制
- **v2.0.0**: 升级到STM32F4系列，添加视觉巡线

## 支持与联系

### 问题反馈
- **GitHub Issues**: [项目Issues页面](https://github.com/BBOOOKK/STM32_car/issues)
- **邮件联系**: 通过GitHub个人资料页获取联系方式
- **技术讨论**: 在相关技术论坛发帖讨论

### 获取帮助
1. **查阅文档**: 首先阅读本文档和相关资源文件
2. **查看示例**: 参考多平台驱动示例代码
3. **搜索问题**: 在Issues中搜索类似问题
4. **提问技巧**: 提供详细的问题描述和复现步骤

### 社区参与
- **Star项目**: 如果你觉得项目有用，请给项目点Star
- **分享经验**: 在技术社区分享使用经验
- **贡献代码**: 欢迎提交Pull Request改进项目
- **推广项目**: 在教育或研究项目中应用本项目

---

**项目主页**: [https://github.com/BBOOOKK/STM32_car](https://github.com/BBOOOKK/STM32_car)

**最后更新**: 2024年12月24日

**维护状态**: 活跃维护

---
*让智能小车在赛道上自由驰骋，探索嵌入式控制的无限可能！*
