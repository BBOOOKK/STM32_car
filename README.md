# STM32 8路巡线智能小车项目

## 项目概述

本项目是一个基于STM32F103C8T6微控制器的智能巡线小车系统，使用5路（实际为5路，但项目标题为8路）巡线传感器实现黑线跟踪功能。小车通过灰度传感器检测地面黑线，根据传感器数据计算偏差并控制电机和舵机实现精确的路径跟踪。

## 项目结构

```
STM32_car/
├── README.md                          # 项目说明文档
├── 巡线传感器/                         # 巡线传感器相关资源
│   ├── 1、巡线模块的测试与调试（必看）/   # 测试与调试资料
│   ├── 2、Arduino驱动程序/             # Arduino平台驱动
│   ├── 3、树莓派驱动程序/              # 树莓派平台驱动
│   ├── 4、51驱动程序/                  # 51单片机驱动
│   ├── 5、STM32驱动程序/               # STM32平台驱动
│   │   ├── GD32F103C8T6驱动/          # GD32芯片驱动
│   │   ├── STM32F103C8T6驱动/         # STM32F103C8T6驱动
│   │   └── STM32F103RCT6&APM32f103RET6驱动/
│   ├── 6、microbit驱动程序/           # microbit平台驱动
│   ├── 7、MSPM0驱动程序/              # MSPM0平台驱动
│   ├── 引脚示意图/                     # 传感器引脚连接图
│   └── 原理图/                        # 电路原理图
├── STM32/                             # STM32主项目代码
│   └── STM32/
│       ├── Hardware/                  # 硬件驱动层
│       │   ├── Track.c/h              # 巡线传感器驱动
│       │   ├── Motor.c/h              # 电机驱动
│       │   ├── PID.c/h                # PID控制算法
│       │   ├── Encoder.c/h            # 编码器测速
│       │   ├── Servor.c/h             # 舵机控制
│       │   ├── OLED.c/h               # OLED显示
│       │   ├── Buzzer.c/h             # 蜂鸣器控制
│       │   ├── Key.c/h                # 按键处理
│       │   └── ...                    # 其他硬件驱动
│       ├── User/                      # 用户应用层
│       │   ├── main.c                 # 主程序
│       │   └── main.h                 # 主程序头文件
│       ├── Library/                   # STM32标准库
│       └── Project.uvprojx            # Keil MDK工程文件
├── STM32_8路巡线/                      # 另一个STM32项目副本
└── STM32F103C8T6驱动/                  # 驱动示例和实验
    └── 4WD智能车/                      # 四轮驱动智能车示例
```

## 硬件配置

### 核心控制器
- **主控芯片**: STM32F103C8T6 (ARM Cortex-M3内核)
- **工作频率**: 72MHz
- **Flash**: 64KB, RAM: 20KB

### 传感器模块
- **巡线传感器**: 5路灰度传感器阵列
  - Track_L (GPIO_Pin_0) - 最左侧传感器
  - Track_l (GPIO_Pin_1) - 左侧传感器
  - Track_M (GPIO_Pin_2) - 中间传感器
  - Track_r (GPIO_Pin_3) - 右侧传感器
  - Track_R (GPIO_Pin_4) - 最右侧传感器
- **连接端口**: GPIOA

### 执行机构
- **电机驱动**: PWM控制直流电机
- **舵机控制**: 用于转向控制
- **编码器**: 用于速度测量和闭环控制

### 人机交互
- **OLED显示屏**: I2C接口，显示传感器数据和状态
- **蜂鸣器**: 状态提示音
- **按键**: 用户输入控制

## 软件架构

### 核心算法

#### 1. 巡线传感器数据处理 (`Track.c/h`)
```c
// 传感器初始化
void Track_Init(void);

// 读取传感器数据
void Read_Track_DATA(uint8_t* arr);

// 计算跟踪误差
float Track_Err(uint16_t car_state);
```

#### 2. 方向状态机 (`main.c`)
系统使用枚举状态机来跟踪小车相对于黑线的位置：
```c
enum status {
    L5, L4, L3, L2, L1,  // 左侧偏移状态
    M,                   // 居中状态
    R1, R2, R3, R4, R5   // 右侧偏移状态
} dir_status, last_dir_status;
```

#### 3. 控制策略
- **单传感器检测**: 精确确定偏移方向
- **双传感器检测**: 处理传感器间位置
- **无传感器检测**: 基于历史数据和趋势预测

### 主要功能模块

1. **传感器数据采集**: 实时读取5路灰度传感器状态
2. **状态判断**: 根据传感器数据判断小车当前位置状态
3. **方向控制**: 通过舵机和差速控制实现转向
4. **速度控制**: PWM调节电机速度
5. **数据显示**: OLED实时显示传感器数据和状态
6. **用户交互**: 按键控制启停和模式切换

## 工作原理

### 巡线原理
1. 灰度传感器发射红外光并接收反射光
2. 黑色表面吸收红外光，反射弱 → 传感器输出低电平
3. 白色表面反射红外光，反射强 → 传感器输出高电平
4. 通过5个传感器的组合状态判断黑线位置

### 控制流程
```
传感器数据采集 → 状态判断 → 误差计算 → 控制输出 → 电机/舵机执行
      ↑                                            ↓
      └─────────── 状态反馈 ───────────────┘
```

### 状态转换逻辑
- **居中状态(M)**: 中间传感器检测到黑线
- **轻微偏移(L1/R1)**: 中间和左/右侧传感器同时检测
- **明显偏移(L2/R2)**: 仅左/右侧传感器检测
- **严重偏移(L3/R3, L4/R4, L5/R5)**: 更外侧传感器检测

## 编译与烧录

### 开发环境
- **IDE**: Keil MDK-ARM (uVision)
- **编译器**: ARMCC
- **调试器**: J-Link/ST-Link

### 编译步骤
1. 打开 `STM32/STM32/Project.uvprojx` 工程文件
2. 配置正确的设备型号 (STM32F103C8T6)
3. 设置正确的晶振频率 (8MHz)
4. 编译工程生成 `Project.axf` 文件
5. 通过ST-Link烧录到目标板

### 硬件连接
1. 连接5V电源到小车
2. 连接ST-Link调试器到SWD接口
3. 确保所有传感器和电机连接正确

## 使用说明

### 启动流程
1. 上电后系统初始化所有外设
2. OLED显示欢迎界面和传感器数据
3. 蜂鸣器发出启动提示音
4. 系统进入主循环，开始巡线

### 操作模式
- **自动模式**: 上电后自动开始巡线
- **手动模式**: 通过按键控制小车运动（如实现）

### 状态显示
OLED显示屏实时显示：
- 5路传感器状态（十六进制）
- 当前方向控制值
- 上一帧状态
- 方向变化趋势
- 当前帧状态

## 参数调整

### 关键调参点
1. **方向控制参数** (`main.c`中的dir赋值):
   ```c
   case L1: dir = -50;  // 轻微左转
   case L2: dir = -80;  // 中等左转
   case L3: dir = -110; // 明显左转
   case L4: dir = -120; // 严重左转
   case L5: dir = -180; // 极限左转
   ```

2. **电机控制参数**:
   ```c
   Move_control(1100+0.7*dir, 1125-0.2*dir);  // 右转时
   Move_control(1100+0.2*dir, 1125-0.7*dir);  // 左转时
   ```

3. **传感器阈值**: 在 `Track.c` 中调整传感器读取逻辑

### 调试技巧
1. 使用OLED观察传感器实时数据
2. 调整dir值优化转弯响应
3. 修改电机PWM参数平衡速度与稳定性
4. 根据实际赛道调整状态机阈值

## 扩展功能

### 已实现功能
- [x] 5路巡线传感器数据采集
- [x] 状态机-based方向控制
- [x] 舵机/PWM电机控制
- [x] OLED实时状态显示
- [x] 蜂鸣器提示音

### 可扩展功能
- [ ] PID速度闭环控制
- [ ] 编码器测速与里程计算
- [ ] MPU6050姿态传感器集成
- [ ] 蓝牙/WiFi远程控制
- [ ] 摄像头视觉识别
- [ ] 多模式切换（巡线、避障、遥控）

## 故障排除

### 常见问题
1. **小车不移动**
   - 检查电机电源连接
   - 验证PWM输出信号
   - 检查电机驱动芯片

2. **传感器无响应**
   - 检查传感器电源（5V）
   - 验证GPIO连接
   - 测试传感器单独工作

3. **巡线不稳定**
   - 调整传感器高度
   - 优化控制参数
   - 检查地面反光情况

4. **编译错误**
   - 确认Keil设备包已安装
   - 检查头文件路径
   - 验证库文件完整性

### 调试工具
1. **Keil Debugger**: 单步调试，查看变量
2. **逻辑分析仪**: 分析PWM信号时序
3. **万用表**: 检查电源和信号电压
4. **串口调试**: 添加printf输出调试信息

## 资源文件

### 文档资料
- `巡线传感器/原理图/`: 电路原理图
- `巡线传感器/引脚示意图/`: 连接引脚图
- `巡线传感器/1、巡线模块的测试与调试（必看）/`: 测试指南

### 视频教程
- `巡线传感器/2、Arduino驱动程序/寻线视频教程.avi`
- `STM32F103C8T6驱动/4WD智能车/6.小车巡线实验.avi`

### 驱动示例
- Arduino, 树莓派, 51单片机, microbit, MSPM0等多平台示例代码

## 许可证

本项目开源，可用于学习和商业用途，请遵循相关硬件和软件组件的原始许可证。

## 贡献指南

欢迎提交Issue和Pull Request来改进本项目。

## 更新日志

### v1.0
- 初始版本发布
- 实现基本巡线功能
- 完成硬件驱动和控制系统
- 添加状态显示和用户交互

## 联系方式

如有问题或建议，请通过项目GitHub页面提交Issue。

---
**注意**: 实际使用前请仔细阅读相关文档，确保硬件连接正确，避免短路或损坏设备。
